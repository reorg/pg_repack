--
-- no superuser check
--
SET client_min_messages = error;
DROP ROLE IF EXISTS nosuper;
SET client_min_messages = warning;
CREATE ROLE nosuper WITH LOGIN;
-- => OK
\! pg_repack --dbname=contrib_regression --table=tbl_cluster --no-superuser-check
INFO: repacking table "public.tbl_cluster"
-- => ERROR
\! pg_repack --dbname=contrib_regression --table=tbl_cluster --username=nosuper
ERROR: pg_repack failed with error: You must be a superuser to use pg_repack
-- => ERROR
\! pg_repack --dbname=contrib_regression --table=tbl_cluster --username=nosuper --no-superuser-check
INFO: repacking table "public.tbl_cluster"
WARNING: lock_exclusive() failed for public.tbl_cluster
ERROR:  permission denied for relation tbl_cluster
CREATE SCHEMA nosuper;
GRANT ALL ON SCHEMA nosuper TO nosuper;
SET SESSION AUTHORIZATION nosuper;
CREATE TABLE nosuper.nosuper_test (id SERIAL PRIMARY KEY, data TEXT);
INSERT INTO nosuper.nosuper_test (data) VALUES ('row1'), ('row2');
RESET SESSION AUTHORIZATION;
-- => OK
\! pg_repack --dbname=contrib_regression --table=nosuper.nosuper_test --username=nosuper --no-superuser-check
INFO: repacking table "nosuper.nosuper_test"
DROP TABLE IF EXISTS nosuper.nosuper_test;
DROP SCHEMA IF EXISTS nosuper;
DROP ROLE IF EXISTS nosuper;
